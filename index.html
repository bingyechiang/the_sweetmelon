<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复杂迷宫探险</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a12 0%, #15152b 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* 导航栏样式 */
        nav {
            background-color: rgba(10, 15, 35, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid #4ecca3;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4, #a1c4fd);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
        }
        
        .nav-link {
            color: #b8c1ec;
            text-decoration: none;
            font-size: 1.1rem;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(78, 204, 163, 0.2);
            color: #fff;
        }
        
        .nav-link.active {
            background-color: #4ecca3;
            color: #1a1a2e;
            font-weight: bold;
        }
        
        .container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .left-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 300px;
        }
        
        header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #a1c4fd);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #b8c1ec;
            margin-bottom: 5px;
        }
        
        .game-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-box {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-title {
            font-size: 0.9rem;
            color: #b8c1ec;
            margin-bottom: 8px;
        }
        
        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #e6e6e6;
        }
        
        .game-board-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: rgba(15, 20, 40, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }
        
        .game-board {
            position: relative;
            background-color: #0a1020;
            border-radius: 5px;
            overflow: hidden;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #maze {
            display: grid;
            grid-template-columns: repeat(31, 20px);
            grid-template-rows: repeat(31, 20px);
            gap: 0;
        }
        
        .cell {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .wall {
            background-color: #1a1a2e;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .path {
            background-color: #0a1020;
        }
        
        .player {
            background-color: #ff9a9e;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            position: relative;
            z-index: 2;
            box-shadow: 0 0 8px #ff9a9e;
            transition: all 0.2s;
        }
        
        .exit {
            background-color: #4ecca3;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 8px #4ecca3;
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .coin {
            background-color: #ffd166;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 5px #ffd166;
        }
        
        .trap {
            background-color: #ff595e;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 6px #ff595e;
            animation: blink 1s infinite alternate;
        }
        
        @keyframes blink {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }
        
        .power-up {
            background-color: #6a4c93;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 8px #6a4c93;
            animation: rotate 3s infinite linear;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            background-color: #394867;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .control-btn:hover {
            background-color: #4a5a7a;
            transform: translateY(-3px);
        }
        
        .control-btn:active {
            transform: translateY(1px);
        }
        
        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }
        .down { grid-column: 2; grid-row: 3; }
        
        .keyboard-hint {
            color: #b8c1ec;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            padding: 12px 25px;
            background-color: #4ecca3;
            color: #1a1a2e;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            -webkit-tap-highlight-color: transparent;
        }
        
        .action-btn:hover {
            background-color: #6fffd4;
            transform: translateY(-3px);
        }
        
        .action-btn.reset {
            background-color: #ff9a9e;
        }
        
        .action-btn.reset:hover {
            background-color: #ffb3b6;
        }
        
        .action-btn.difficulty {
            background-color: #6a4c93;
        }
        
        .action-btn.difficulty:hover {
            background-color: #7d5fb2;
        }
        
        /* 公告栏样式 */
        .announcement-board {
            background-color: rgba(15, 20, 40, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .board-title {
            font-size: 1.5rem;
            color: #4ecca3;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .announcement-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .announcement-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .announcement-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .announcement-content::-webkit-scrollbar-thumb {
            background: #4ecca3;
            border-radius: 4px;
        }
        
        .announcement-item {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4ecca3;
        }
        
        .announcement-item h3 {
            color: #ffd166;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .announcement-item p {
            color: #e6e6e6;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .announcement-item .time {
            color: #b8c1ec;
            font-size: 0.8rem;
            margin-top: 8px;
            text-align: right;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .difficulty-btn {
            flex: 1;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: #b8c1ec;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .difficulty-btn:hover {
            background-color: rgba(78, 204, 163, 0.2);
            color: #fff;
        }
        
        .difficulty-btn.active {
            background-color: #4ecca3;
            color: #1a1a2e;
            font-weight: bold;
        }
        
        .win-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }
        
        .win-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        
        .win-content h2 {
            font-size: 2.5rem;
            color: #4ecca3;
            margin-bottom: 20px;
        }
        
        .win-stats {
            font-size: 1.3rem;
            margin-bottom: 25px;
            color: #e6e6e6;
        }
        
        .win-stats div {
            margin: 10px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }
        
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .right-panel {
                min-width: 100%;
            }
            
            #maze {
                grid-template-columns: repeat(31, 16px);
                grid-template-rows: repeat(31, 16px);
            }
            
            .cell {
                width: 16px;
                height: 16px;
            }
            
            .player, .exit {
                width: 12px;
                height: 12px;
            }
            
            .coin, .trap, .power-up {
                width: 8px;
                height: 8px;
            }
        }
        
        @media (max-width: 768px) {
            .game-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            nav {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav>
        <div class="logo">迷宫探险</div>
        <div class="nav-links">
            <a href="#" class="nav-link active" id="gameTab">游戏</a>
            <a href="#" class="nav-link" id="announcementTab">公告</a>
            <a href="#" class="nav-link" id="instructionsTab">说明</a>
            <a href="#" class="nav-link" id="rankingsTab">排行榜</a>
        </div>
    </nav>
    
    <div class="container">
        <!-- 左侧游戏区域 -->
        <div class="left-panel" id="gamePanel">
            <header>
                <h1>复杂迷宫探险</h1>
                <p class="subtitle">探索随机生成的复杂迷宫，躲避陷阱，收集道具，找到出口！</p>
            </header>
            
            <div class="game-info">
                <div class="info-box">
                    <div class="info-title">时间</div>
                    <div class="info-value" id="timer">00:00</div>
                </div>
                <div class="info-box">
                    <div class="info-title">步数</div>
                    <div class="info-value" id="steps">0</div>
                </div>
                <div class="info-box">
                    <div class="info-title">金币</div>
                    <div class="info-value" id="coins">0</div>
                </div>
                <div class="info-box">
                    <div class="info-title">难度</div>
                    <div class="info-value" id="difficulty">普通</div>
                </div>
            </div>
            
            <div class="game-board-container">
                <div class="game-board">
                    <div id="maze"></div>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-buttons">
                    <button class="control-btn up" id="up">↑</button>
                    <button class="control-btn left" id="left">←</button>
                    <button class="control-btn right" id="right">→</button>
                    <button class="control-btn down" id="down">↓</button>
                </div>
                <p class="keyboard-hint">使用键盘方向键或屏幕按钮控制移动</p>
            </div>
            
            <div class="actions">
                <button class="action-btn reset" id="resetBtn">重新开始</button>
                <button class="action-btn difficulty" id="newMazeBtn">生成新迷宫</button>
                <button class="action-btn" id="autoSolveBtn">提示路径</button>
            </div>
            
            <div class="difficulty-selector">
                <button class="difficulty-btn active" data-level="easy">简单</button>
                <button class="difficulty-btn" data-level="normal">普通</button>
                <button class="difficulty-btn" data-level="hard">困难</button>
                <button class="difficulty-btn" data-level="extreme">地狱</button>
            </div>
        </div>
        
        <!-- 右侧公告栏 -->
        <div class="right-panel" id="announcementPanel">
            <div class="announcement-board">
                <h2 class="board-title">游戏公告</h2>
                <div class="announcement-content" id="announcementContent">
                    <!-- 公告内容将通过JS动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 说明面板（初始隐藏） -->
        <div class="right-panel" id="instructionsPanel" style="display:none">
            <div class="announcement-board">
                <h2 class="board-title">游戏说明</h2>
                <div class="announcement-content">
                    <div class="announcement-item">
                        <h3>游戏目标</h3>
                        <p>控制粉色角色找到绿色出口，并尽可能多地收集金币和道具。</p>
                    </div>
                    <div class="announcement-item">
                        <h3>游戏元素</h3>
                        <p>• 粉色圆点：玩家角色<br>
                           • 绿色圆点：出口（目标）<br>
                           • 黄色圆点：金币（收集可得分）<br>
                           • 红色圆点：陷阱（触碰会扣分）<br>
                           • 紫色圆点：能量道具（暂时加速）</p>
                    </div>
                    <div class="announcement-item">
                        <h3>控制方式</h3>
                        <p>• 使用键盘方向键（↑↓←→）控制角色移动<br>
                           • 或点击屏幕上的方向按钮进行移动</p>
                    </div>
                    <div class="announcement-item">
                        <h3>计分规则</h3>
                        <p>• 到达出口：+1000分<br>
                           • 收集金币：+100分/个<br>
                           • 触碰陷阱：-50分/个<br>
                           • 收集能量道具：+200分/个，并加速5秒<br>
                           • 每10步：-1分<br>
                           • 每10秒：-1分</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 排行榜面板（初始隐藏） -->
        <div class="right-panel" id="rankingsPanel" style="display:none">
            <div class="announcement-board">
                <h2 class="board-title">排行榜</h2>
                <div class="announcement-content" id="rankingsContent">
                    <!-- 排行榜内容将通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 胜利消息 -->
    <div class="win-message" id="winMessage">
        <div class="win-content">
            <h2>恭喜通关！</h2>
            <div class="win-stats">
                <div>完成时间: <span id="winTime">00:00</span></div>
                <div>总步数: <span id="winSteps">0</span></div>
                <div>收集金币: <span id="winCoins">0</span> / <span id="totalCoins">0</span></div>
                <div>最终得分: <span id="winScore">0</span></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="info-title">陷阱触碰</div>
                    <div class="info-value" id="winTraps">0</div>
                </div>
                <div class="stat-box">
                    <div class="info-title">道具收集</div>
                    <div class="info-value" id="winPowerUps">0</div>
                </div>
                <div class="stat-box">
                    <div class="info-title">地图大小</div>
                    <div class="info-value" id="winMazeSize">31×31</div>
                </div>
                <div class="stat-box">
                    <div class="info-title">游戏难度</div>
                    <div class="info-value" id="winDifficulty">普通</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="action-btn" id="playAgainBtn">再玩一次</button>
                <button class="action-btn reset" id="shareBtn" style="margin-left: 15px;">分享成绩</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态变量
        let maze = [];
        let playerPos = {x: 1, y: 1};
        let exitPos = {x: 29, y: 29};
        let coins = [];
        let traps = [];
        let powerUps = [];
        let steps = 0;
        let coinsCollected = 0;
        let trapsHit = 0;
        let powerUpsCollected = 0;
        let startTime = null;
        let timerInterval = null;
        let gameActive = false;
        let currentDifficulty = 'normal';
        let mazeSize = 31;
        let powerUpActive = false;
        let powerUpEndTime = null;
        
        // 难度配置
        const difficultyConfig = {
            easy: { mazeSize: 21, coins: 8, traps: 5, powerUps: 2 },
            normal: { mazeSize: 31, coins: 15, traps: 10, powerUps: 4 },
            hard: { mazeSize: 41, coins: 25, traps: 20, powerUps: 6 },
            extreme: { mazeSize: 51, coins: 40, traps: 35, powerUps: 8 }
        };
        
        // 游戏记录
        let gameHistory = JSON.parse(localStorage.getItem('mazeGameHistory')) || [];
        
        // DOM元素
        const mazeElement = document.getElementById('maze');
        const timerElement = document.getElementById('timer');
        const stepsElement = document.getElementById('steps');
        const coinsElement = document.getElementById('coins');
        const difficultyElement = document.getElementById('difficulty');
        const winMessage = document.getElementById('winMessage');
        const winTimeElement = document.getElementById('winTime');
        const winStepsElement = document.getElementById('winSteps');
        const winCoinsElement = document.getElementById('winCoins');
        const totalCoinsElement = document.getElementById('totalCoins');
        const winScoreElement = document.getElementById('winScore');
        const winTrapsElement = document.getElementById('winTraps');
        const winPowerUpsElement = document.getElementById('winPowerUps');
        const winMazeSizeElement = document.getElementById('winMazeSize');
        const winDifficultyElement = document.getElementById('winDifficulty');
        const announcementContent = document.getElementById('announcementContent');
        const rankingsContent = document.getElementById('rankingsContent');
        
        // 面板切换
        const gameTab = document.getElementById('gameTab');
        const announcementTab = document.getElementById('announcementTab');
        const instructionsTab = document.getElementById('instructionsTab');
        const rankingsTab = document.getElementById('rankingsTab');
        const gamePanel = document.getElementById('gamePanel');
        const announcementPanel = document.getElementById('announcementPanel');
        const instructionsPanel = document.getElementById('instructionsPanel');
        const rankingsPanel = document.getElementById('rankingsPanel');
        
        // ==============================================
        // 公告栏静态内容 - 在这里编辑公告栏的初始内容
        // ==============================================
        const staticAnnouncements = [
            {
                title: "游戏公告",
                content: "杜怀瑾是我的儿子",
                time: "18:27"
            },
            {
                title: "更新内容",
                content: "版本1.1更新：修复了方向键滚动问题，优化了移动控制，现在使用方向键时页面不会滚动了。",
                time: "09:30"
            },
            {
                title: "游戏技巧",
                content: "提示：使用'提示路径'功能可以显示最短路径的前几步，帮助你解决困难关卡。",
                time: "09:15"
            },
            {
                title: "道具说明",
                content: "紫色能量道具可以让你在5秒内移动速度加倍，合理利用可以更快到达出口。",
                time: "09:00"
            },
            {
                title: "排行榜功能",
                content: "游戏现在支持本地排行榜，你的最佳成绩会被记录在排行榜中。",
                time: "08:45"
            }
        ];
        
        // 初始化游戏
        function initGame() {
            // 重置游戏状态
            const config = difficultyConfig[currentDifficulty];
            mazeSize = config.mazeSize;
            
            // 生成随机迷宫
            generateRandomMaze();
            
            // 重置玩家位置
            playerPos = {x: 1, y: 1};
            
            // 生成随机出口位置（确保是路径且在迷宫边缘附近）
            do {
                exitPos = {
                    x: Math.floor(Math.random() * (mazeSize - 2)) + 1,
                    y: Math.floor(Math.random() * (mazeSize - 2)) + 1
                };
            } while (maze[exitPos.y][exitPos.x] !== 0 || 
                     (exitPos.x === 1 && exitPos.y === 1) ||
                     (exitPos.x > mazeSize - 5 && exitPos.y > mazeSize - 5));
            
            // 生成游戏物品
            generateGameItems(config);
            
            // 重置统计数据
            steps = 0;
            coinsCollected = 0;
            trapsHit = 0;
            powerUpsCollected = 0;
            powerUpActive = false;
            powerUpEndTime = null;
            gameActive = true;
            
            // 更新显示
            stepsElement.textContent = steps;
            coinsElement.textContent = coinsCollected;
            difficultyElement.textContent = getDifficultyName(currentDifficulty);
            
            // 开始计时
            startTimer();
            
            // 渲染迷宫
            renderMaze();
            
            // 隐藏胜利消息
            winMessage.style.display = 'none';
            
            // 更新公告
            addAnnouncement("游戏开始", `新的${getDifficultyName(currentDifficulty)}难度迷宫已生成！地图大小：${mazeSize}×${mazeSize}`);
        }
        
        // 使用深度优先搜索生成随机迷宫
        function generateRandomMaze() {
            // 初始化迷宫，全部为墙
            maze = Array(mazeSize).fill().map(() => Array(mazeSize).fill(1));
            
            // 使用递归回溯算法生成迷宫
            const stack = [];
            const startX = 1, startY = 1;
            
            // 将起点设为路径
            maze[startY][startX] = 0;
            stack.push({x: startX, y: startY});
            
            // 方向数组：上、右、下、左
            const directions = [
                {dx: 0, dy: -2},
                {dx: 2, dy: 0},
                {dx: 0, dy: 2},
                {dx: -2, dy: 0}
            ];
            
            while (stack.length > 0) {
                const current = stack[stack.length - 1];
                
                // 获取未访问的邻居
                const neighbors = [];
                for (const dir of directions) {
                    const nx = current.x + dir.dx;
                    const ny = current.y + dir.dy;
                    
                    if (nx > 0 && nx < mazeSize - 1 && ny > 0 && ny < mazeSize - 1 && maze[ny][nx] === 1) {
                        // 检查邻居的邻居是否是墙
                        const nnx = current.x + dir.dx / 2;
                        const nny = current.y + dir.dy / 2;
                        if (maze[nny][nnx] === 1) {
                            neighbors.push({x: nx, y: ny, wallX: nnx, wallY: nny});
                        }
                    }
                }
                
                if (neighbors.length > 0) {
                    // 随机选择一个邻居
                    const randomNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
                    
                    // 打通当前单元格和邻居之间的墙
                    maze[randomNeighbor.wallY][randomNeighbor.wallX] = 0;
                    maze[randomNeighbor.y][randomNeighbor.x] = 0;
                    
                    // 将邻居压入栈
                    stack.push({x: randomNeighbor.x, y: randomNeighbor.y});
                } else {
                    // 如果没有未访问的邻居，回溯
                    stack.pop();
                }
            }
            
            // 确保迷宫有足够的连通性（额外打通一些墙）
            for (let i = 0; i < mazeSize * 2; i++) {
                const x = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                const y = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                
                if (maze[y][x] === 1) {
                    // 检查四周是否有路径
                    let pathCount = 0;
                    if (y > 0 && maze[y-1][x] === 0) pathCount++;
                    if (y < mazeSize - 1 && maze[y+1][x] === 0) pathCount++;
                    if (x > 0 && maze[y][x-1] === 0) pathCount++;
                    if (x < mazeSize - 1 && maze[y][x+1] === 0) pathCount++;
                    
                    if (pathCount >= 2) {
                        maze[y][x] = 0;
                    }
                }
            }
            
            // 确保边缘是墙
            for (let i = 0; i < mazeSize; i++) {
                maze[0][i] = 1;
                maze[mazeSize-1][i] = 1;
                maze[i][0] = 1;
                maze[i][mazeSize-1] = 1;
            }
        }
        
        // 生成游戏物品（金币、陷阱、道具）
        function generateGameItems(config) {
            coins = [];
            traps = [];
            powerUps = [];
            
            // 生成金币
            for (let i = 0; i < config.coins; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                    y = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                } while (maze[y][x] !== 0 || 
                         (x === playerPos.x && y === playerPos.y) ||
                         (x === exitPos.x && y === exitPos.y) ||
                         coins.some(coin => coin.x === x && coin.y === y));
                
                coins.push({x, y});
            }
            
            // 生成陷阱
            for (let i = 0; i < config.traps; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                    y = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                } while (maze[y][x] !== 0 || 
                         (x === playerPos.x && y === playerPos.y) ||
                         (x === exitPos.x && y === exitPos.y) ||
                         traps.some(trap => trap.x === x && trap.y === y) ||
                         coins.some(coin => coin.x === x && coin.y === y));
                
                traps.push({x, y});
            }
            
            // 生成能量道具
            for (let i = 0; i < config.powerUps; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                    y = Math.floor(Math.random() * (mazeSize - 2)) + 1;
                } while (maze[y][x] !== 0 || 
                         (x === playerPos.x && y === playerPos.y) ||
                         (x === exitPos.x && y === exitPos.y) ||
                         powerUps.some(pu => pu.x === x && pu.y === y) ||
                         coins.some(coin => coin.x === x && coin.y === y) ||
                         traps.some(trap => trap.x === x && trap.y === y));
                
                powerUps.push({x, y});
            }
        }
        
        // 渲染迷宫
        function renderMaze() {
            mazeElement.innerHTML = '';
            mazeElement.style.gridTemplateColumns = `repeat(${mazeSize}, 20px)`;
            mazeElement.style.gridTemplateRows = `repeat(${mazeSize}, 20px)`;
            
            // 调整小屏幕显示
            if (window.innerWidth <= 1200) {
                const cellSize = Math.max(12, Math.floor(500 / mazeSize));
                mazeElement.style.gridTemplateColumns = `repeat(${mazeSize}, ${cellSize}px)`;
                mazeElement.style.gridTemplateRows = `repeat(${mazeSize}, ${cellSize}px)`;
            }
            
            for (let y = 0; y < mazeSize; y++) {
                for (let x = 0; x < mazeSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    if (maze[y][x] === 1) {
                        cell.classList.add('wall');
                    } else {
                        cell.classList.add('path');
                        
                        // 检查是否是玩家位置
                        if (playerPos.x === x && playerPos.y === y) {
                            const player = document.createElement('div');
                            player.className = 'player';
                            if (powerUpActive) {
                                player.style.boxShadow = '0 0 15px #ff9a9e, 0 0 30px #ff9a9e';
                                player.style.animation = 'pulse 0.5s infinite alternate';
                            }
                            cell.appendChild(player);
                        }
                        
                        // 检查是否是出口位置
                        if (exitPos.x === x && exitPos.y === y) {
                            const exit = document.createElement('div');
                            exit.className = 'exit';
                            cell.appendChild(exit);
                        }
                        
                        // 检查是否是金币位置
                        const coinIndex = coins.findIndex(coin => coin.x === x && coin.y === y);
                        if (coinIndex !== -1) {
                            const coin = document.createElement('div');
                            coin.className = 'coin';
                            cell.appendChild(coin);
                        }
                        
                        // 检查是否是陷阱位置
                        const trapIndex = traps.findIndex(trap => trap.x === x && trap.y === y);
                        if (trapIndex !== -1) {
                            const trap = document.createElement('div');
                            trap.className = 'trap';
                            cell.appendChild(trap);
                        }
                        
                        // 检查是否是能量道具位置
                        const powerUpIndex = powerUps.findIndex(pu => pu.x === x && pu.y === y);
                        if (powerUpIndex !== -1) {
                            const powerUp = document.createElement('div');
                            powerUp.className = 'power-up';
                            cell.appendChild(powerUp);
                        }
                    }
                    
                    mazeElement.appendChild(cell);
                }
            }
        }
        
        // 开始计时器
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }
        
        // 更新计时器显示
        function updateTimer() {
            if (!startTime) return;
            
            const currentTime = new Date();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            
            const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
            const seconds = (elapsedTime % 60).toString().padStart(2, '0');
            
            timerElement.textContent = `${minutes}:${seconds}`;
            
            // 检查能量道具是否过期
            if (powerUpActive && powerUpEndTime && currentTime > powerUpEndTime) {
                powerUpActive = false;
                powerUpEndTime = null;
                renderMaze();
                addAnnouncement("能量效果结束", "你的移动速度已恢复正常");
            }
        }
        
        // 获取计时器值（秒）
        function getTimerValue() {
            if (!startTime) return 0;
            
            const currentTime = new Date();
            return Math.floor((currentTime - startTime) / 1000);
        }
        
        // 获取难度名称
        function getDifficultyName(level) {
            const names = {
                easy: '简单',
                normal: '普通',
                hard: '困难',
                extreme: '地狱'
            };
            return names[level] || '普通';
        }
        
        // 设置控制
        function setupControls() {
            // 键盘控制 - 修复滚动问题
            document.addEventListener('keydown', handleKeyDown);
            
            // 按钮控制
            document.getElementById('up').addEventListener('click', () => movePlayer(0, -1));
            document.getElementById('down').addEventListener('click', () => movePlayer(0, 1));
            document.getElementById('left').addEventListener('click', () => movePlayer(-1, 0));
            document.getElementById('right').addEventListener('click', () => movePlayer(1, 0));
            
            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', initGame);
            
            // 新迷宫按钮
            document.getElementById('newMazeBtn').addEventListener('click', initGame);
            
            // 自动求解按钮
            document.getElementById('autoSolveBtn').addEventListener('click', showHint);
            
            // 难度选择按钮
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDifficulty = this.dataset.level;
                    initGame();
                });
            });
            
            // 再玩一次按钮
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                winMessage.style.display = 'none';
                initGame();
            });
            
            // 分享按钮
            document.getElementById('shareBtn').addEventListener('click', shareScore);
            
            // 导航栏切换
            gameTab.addEventListener('click', (e) => {
                e.preventDefault();
                switchPanel('game');
            });
            
            announcementTab.addEventListener('click', (e) => {
                e.preventDefault();
                switchPanel('announcement');
            });
            
            instructionsTab.addEventListener('click', (e) => {
                e.preventDefault();
                switchPanel('instructions');
            });
            
            rankingsTab.addEventListener('click', (e) => {
                e.preventDefault();
                switchPanel('rankings');
                updateRankings();
            });
        }
        
        // 切换面板
        function switchPanel(panel) {
            // 重置所有选项卡
            gameTab.classList.remove('active');
            announcementTab.classList.remove('active');
            instructionsTab.classList.remove('active');
            rankingsTab.classList.remove('active');
            
            // 隐藏所有面板
            gamePanel.style.display = 'none';
            announcementPanel.style.display = 'none';
            instructionsPanel.style.display = 'none';
            rankingsPanel.style.display = 'none';
            
            // 显示选中的面板和激活对应的选项卡
            switch(panel) {
                case 'game':
                    gamePanel.style.display = 'flex';
                    gameTab.classList.add('active');
                    break;
                case 'announcement':
                    announcementPanel.style.display = 'flex';
                    announcementTab.classList.add('active');
                    break;
                case 'instructions':
                    instructionsPanel.style.display = 'flex';
                    instructionsTab.classList.add('active');
                    break;
                case 'rankings':
                    rankingsPanel.style.display = 'flex';
                    rankingsTab.classList.add('active');
                    break;
            }
        }
        
        // 处理键盘输入 - 修复滚动问题
        function handleKeyDown(event) {
            // 阻止方向键的默认行为（页面滚动）
            if ([37, 38, 39, 40].includes(event.keyCode)) {
                event.preventDefault();
            }
            
            if (!gameActive) return;
            
            // 如果能量道具激活，移动速度加快
            let moveCount = powerUpActive ? 2 : 1;
            
            switch(event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    for (let i = 0; i < moveCount; i++) movePlayer(0, -1);
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    for (let i = 0; i < moveCount; i++) movePlayer(0, 1);
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    for (let i = 0; i < moveCount; i++) movePlayer(-1, 0);
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    for (let i = 0; i < moveCount; i++) movePlayer(1, 0);
                    break;
            }
        }
        
        // 移动玩家
        function movePlayer(dx, dy) {
            if (!gameActive) return;
            
            const newX = playerPos.x + dx;
            const newY = playerPos.y + dy;
            
            // 检查是否撞墙
            if (newX < 0 || newX >= mazeSize || newY < 0 || newY >= mazeSize || maze[newY][newX] === 1) return;
            
            // 更新玩家位置
            playerPos.x = newX;
            playerPos.y = newY;
            
            // 增加步数
            steps++;
            stepsElement.textContent = steps;
            
            // 检查是否收集到金币
            const coinIndex = coins.findIndex(coin => coin.x === newX && coin.y === newY);
            if (coinIndex !== -1) {
                coins.splice(coinIndex, 1);
                coinsCollected++;
                coinsElement.textContent = coinsCollected;
                addAnnouncement("收集金币", `获得100分！已收集${coinsCollected}个金币`);
            }
            
            // 检查是否触碰陷阱
            const trapIndex = traps.findIndex(trap => trap.x === newX && trap.y === newY);
            if (trapIndex !== -1) {
                traps.splice(trapIndex, 1);
                trapsHit++;
                addAnnouncement("触碰陷阱", "损失50分！小心躲避红色陷阱");
            }
            
            // 检查是否收集能量道具
            const powerUpIndex = powerUps.findIndex(pu => pu.x === newX && pu.y === newY);
            if (powerUpIndex !== -1) {
                powerUps.splice(powerUpIndex, 1);
                powerUpsCollected++;
                powerUpActive = true;
                powerUpEndTime = new Date(Date.now() + 5000); // 5秒效果
                addAnnouncement("获得能量", "移动速度加倍，效果持续5秒！");
            }
            
            // 检查是否到达出口
            if (newX === exitPos.x && newY === exitPos.y) {
                endGame();
            }
            
            // 重新渲染迷宫
            renderMaze();
        }
        
        // 显示提示（短暂显示路径）
        function showHint() {
            if (!gameActive) return;
            
            // 使用BFS算法找到最短路径
            const path = findShortestPath();
            if (path.length === 0) return;
            
            // 显示路径（前几步）
            const stepsToShow = Math.min(5, path.length);
            for (let i = 0; i < stepsToShow; i++) {
                const pos = path[i];
                setTimeout(() => {
                    const cell = document.querySelector(`.cell[data-x="${pos.x}"][data-y="${pos.y}"]`);
                    if (cell && !cell.classList.contains('player') && !cell.classList.contains('exit')) {
                        cell.style.backgroundColor = 'rgba(78, 204, 163, 0.5)';
                    }
                }, i * 200);
            }
            
            // 3秒后清除提示
            setTimeout(() => {
                renderMaze();
            }, stepsToShow * 200 + 1000);
            
            addAnnouncement("路径提示", "显示了前方几步的最短路径");
        }
        
        // 使用BFS算法找到最短路径
        function findShortestPath() {
            const visited = Array(mazeSize).fill().map(() => Array(mazeSize).fill(false));
            const queue = [{x: playerPos.x, y: playerPos.y, path: []}];
            
            // 方向数组：上、右、下、左
            const directions = [
                {dx: 0, dy: -1},
                {dx: 1, dy: 0},
                {dx: 0, dy: 1},
                {dx: -1, dy: 0}
            ];
            
            while (queue.length > 0) {
                const current = queue.shift();
                
                // 如果到达出口，返回路径
                if (current.x === exitPos.x && current.y === exitPos.y) {
                    return current.path;
                }
                
                // 标记为已访问
                visited[current.y][current.x] = true;
                
                // 检查所有方向
                for (const dir of directions) {
                    const nx = current.x + dir.dx;
                    const ny = current.y + dir.dy;
                    
                    if (nx >= 0 && nx < mazeSize && ny >= 0 && ny < mazeSize && 
                        maze[ny][nx] === 0 && !visited[ny][nx]) {
                        queue.push({
                            x: nx,
                            y: ny,
                            path: [...current.path, {x: nx, y: ny}]
                        });
                    }
                }
            }
            
            return []; // 没有找到路径
        }
        
        // 结束游戏
        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            
            // 计算得分
            const time = getTimerValue();
            const timeScore = Math.max(0, 2000 - time * 5);
            const stepsScore = Math.max(0, 1500 - steps * 2);
            const coinsScore = coinsCollected * 100;
            const trapsPenalty = trapsHit * 50;
            const powerUpsBonus = powerUpsCollected * 200;
            const totalScore = timeScore + stepsScore + coinsScore - trapsPenalty + powerUpsBonus + 1000; // 通关奖励1000分
            
            // 保存游戏记录
            const gameRecord = {
                date: new Date().toLocaleString(),
                difficulty: currentDifficulty,
                score: totalScore,
                time: time,
                steps: steps,
                coins: coinsCollected,
                traps: trapsHit,
                powerUps: powerUpsCollected
            };
            
            gameHistory.push(gameRecord);
            // 只保留最近20条记录
            if (gameHistory.length > 20) gameHistory = gameHistory.slice(-20);
            localStorage.setItem('mazeGameHistory', JSON.stringify(gameHistory));
            
            // 显示胜利消息
            const minutes = Math.floor(time / 60).toString().padStart(2, '0');
            const seconds = (time % 60).toString().padStart(2, '0');
            
            winTimeElement.textContent = `${minutes}:${seconds}`;
            winStepsElement.textContent = steps;
            winCoinsElement.textContent = `${coinsCollected}`;
            totalCoinsElement.textContent = difficultyConfig[currentDifficulty].coins;
            winScoreElement.textContent = totalScore;
            winTrapsElement.textContent = trapsHit;
            winPowerUpsElement.textContent = powerUpsCollected;
            winMazeSizeElement.textContent = `${mazeSize}×${mazeSize}`;
            winDifficultyElement.textContent = getDifficultyName(currentDifficulty);
            
            winMessage.style.display = 'flex';
            
            // 添加公告
            addAnnouncement("游戏通关", `恭喜在${getDifficultyName(currentDifficulty)}难度下通关！得分：${totalScore}`);
        }
        
        // 分享成绩
        function shareScore() {
            const score = document.getElementById('winScore').textContent;
            const time = document.getElementById('winTime').textContent;
            const text = `我在迷宫探险游戏中取得了${score}分的好成绩，用时${time}！你也来试试吧！`;
            
            if (navigator.share) {
                navigator.share({
                    title: '迷宫探险成绩',
                    text: text,
                    url: window.location.href
                });
            } else {
                // 复制到剪贴板
                navigator.clipboard.writeText(text).then(() => {
                    alert("成绩已复制到剪贴板！");
                });
            }
        }
        
        // 添加公告
        function addAnnouncement(title, content) {
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const announcementItem = document.createElement('div');
            announcementItem.className = 'announcement-item';
            announcementItem.innerHTML = `
                <h3>${title}</h3>
                <p>${content}</p>
                <div class="time">${timeStr}</div>
            `;
            
            announcementContent.prepend(announcementItem);
            
            // 限制公告数量
            const items = announcementContent.querySelectorAll('.announcement-item');
            if (items.length > 15) {
                items[items.length - 1].remove();
            }
        }
        
        // 加载静态公告
        function loadStaticAnnouncements() {
            staticAnnouncements.forEach(announcement => {
                const announcementItem = document.createElement('div');
                announcementItem.className = 'announcement-item';
                announcementItem.innerHTML = `
                    <h3>${announcement.title}</h3>
                    <p>${announcement.content}</p>
                    <div class="time">${announcement.time}</div>
                `;
                announcementContent.appendChild(announcementItem);
            });
        }
        
        // 更新排行榜
        function updateRankings() {
            rankingsContent.innerHTML = '';
            
            if (gameHistory.length === 0) {
                rankingsContent.innerHTML = '<p style="text-align:center;color:#b8c1ec;margin-top:20px;">暂无游戏记录</p>';
                return;
            }
            
            // 按分数排序
            const sortedHistory = [...gameHistory].sort((a, b) => b.score - a.score);
            
            // 显示前10名
            const top10 = sortedHistory.slice(0, 10);
            
            top10.forEach((record, index) => {
                const minutes = Math.floor(record.time / 60).toString().padStart(2, '0');
                const seconds = (record.time % 60).toString().padStart(2, '0');
                
                const rankingItem = document.createElement('div');
                rankingItem.className = 'announcement-item';
                rankingItem.innerHTML = `
                    <h3>第${index + 1}名 - ${getDifficultyName(record.difficulty)}</h3>
                    <p>分数: ${record.score} | 时间: ${minutes}:${seconds}</p>
                    <p>步数: ${record.steps} | 金币: ${record.coins}</p>
                    <div class="time">${record.date}</div>
                `;
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    const colors = ['#ffd700', '#c0c0c0', '#cd7f32']; // 金、银、铜
                    rankingItem.style.borderLeftColor = colors[index];
                    rankingItem.querySelector('h3').style.color = colors[index];
                }
                
                rankingsContent.appendChild(rankingItem);
            });
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            setupControls();
            loadStaticAnnouncements();
        });
    </script>
</body>
</html>
